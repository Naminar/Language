
#include "../include/asm.h"
#include "../HashList/list.h"

void pop_user_function_arg(FILE* asm_file, Node* arg_node);
void push_user_function_arg(FILE* asm_file, Node* arg_node);

extern HashTree* tree;

void do_asm_translation(Node* root)
{
    assert (root);

    FILE* asm_file = fopen("asm.txt", "w");

    assert (asm_file);

    //pro_print(root);

    //asm_node_translation(asm_file, root);

    check_asm_command(asm_file, root); //the main programm, on the top

    asm_node_translation(asm_file, root->right_son);

    fprintf(asm_file, "OUT\nHLT\n\n");
        
    asm_node_translation(asm_file, root->left_son);

    fclose(asm_file);
}

void asm_node_translation(FILE* asm_file, Node* node)
{
    if (!node || !asm_file)
        return;

    printf("  ");
    node_fmt_print(stdout, node);
    printf("  \n");

    if (node->type == USER_FUNCTION)
    {
        fprintf(asm_file,"\n%s:\n", node->cell);

        check_asm_command(asm_file, node);

        asm_node_translation(asm_file, node->right_son);

        fprintf(asm_file,"RET\n\n");
        
        asm_node_translation(asm_file, node->left_son);
    }
    else
    {
        asm_node_translation(asm_file, node->left_son);

        asm_node_translation(asm_file, node->right_son);

        check_asm_command(asm_file, node);
    }
}

void check_asm_command(FILE* asm_file, Node* checked_node)
{
    switch (checked_node->type)
    {
        /*case INT:
        {
            fprintf(out_file, "%d", node->data.i_num);

            break;
        }

        case DOT:
        {
            fprintf(out_file, "%.2f", node->data.d_num);

            break;
        }

        case VARIABLE:
        {
            fprintf(out_file, CELL_FMT, node->cell);

            break;
        }

        case EMPTY_NODE:
            return;*/

        case OPERATOR:
        {
            switch (checked_node->data.stat)
            {
                case MUL:
                {
                    father_operand_command_and_pushes(asm_file, checked_node, "MUL");

                    break;
                }

                case PLUS:
                {
                    father_operand_command_and_pushes(asm_file, checked_node, "ADD");

                    break;
                }

                case DIV:
                {
                    father_operand_command_and_pushes(asm_file, checked_node, "DIV");

                    break;
                }

                case MINUS:
                {
                    father_operand_command_and_pushes(asm_file, checked_node, "SUB");

                    break;
                }

                case EQUAL:
                {
                    HashList* found_variable = H_search_list_by_hash(tree, checked_node->left_son->cell);

                    printf("%s; ", checked_node->left_son->cell);

                    assert(found_variable);

                    switch (checked_node->right_son->type)
                    {
                        case INT:
                        {
                            fprintf(asm_file, "PUSH %d\n", checked_node->right_son->data.i_num);

                            break;
                        }

                        case DOT:
                        {
                            fprintf(asm_file, "PUSH %f\n", checked_node->right_son->data.d_num);

                            break;
                        }

                        case VARIABLE:
                        {
                            HashList* equal_variable = H_search_list_by_hash(tree, checked_node->right_son->cell);

                            fprintf(asm_file, "PUSH [%zu]\n", equal_variable->ram_place);

                            break;
                        }

                        case OPERATOR:
                        {
                            break;
                        }
                    }


                    fprintf(asm_file, "POP [%zu]\n\n", found_variable->ram_place);

                    break;
                }
            }


            break;
        }

        case USER_FUNCTION:
        {
            if (checked_node->right_son
                &&
                checked_node->right_son->left_son
               )
            {
                fprintf(asm_file,"\n");

                pop_user_function_arg(asm_file, checked_node->right_son->left_son);

                fprintf(asm_file,"\n");
            }

            break;
        }

        case CALL_USER_FUNCTION:
        {
            if (checked_node->left_son)
                push_user_function_arg(asm_file, checked_node->left_son);

            fprintf(asm_file,"CALL %s\n", checked_node->cell);

            break;
        }
    }
}

void push_user_function_arg(FILE* asm_file, Node* arg_node)
{
    if (arg_node->type == NULL_OPER)
    {
        push_user_function_arg(asm_file, arg_node->right_son);

        push_user_function_arg(asm_file, arg_node->left_son);
    }
    else
    {
        if (arg_node->type ==  VARIABLE)
        {
            HashList* found_variable = H_search_list_by_hash(tree, arg_node->cell);

            fprintf(asm_file, "PUSH [%zu]----\n\n", found_variable->ram_place);
        }
        else
        {
            asm_node_translation(asm_file, arg_node->left_son);

            asm_node_translation(asm_file, arg_node->right_son);
            //check_asm_command(asm_file, arg_node);
        }
    }
}

void pop_user_function_arg(FILE* asm_file, Node* arg_node)
{
    HashList* found_variable = H_search_list_by_hash(tree, arg_node->cell);

    fprintf(asm_file, "POP [%zu]\n", found_variable->ram_place);

    if (arg_node->left_son)
        pop_user_function_arg(asm_file, arg_node->left_son);
}

void father_operand_command_and_pushes(FILE* asm_file, Node* father, const char *const command)
{
    /*if (father->left_son->type == INT)
        fprintf(asm_file, "PUSH %d\n", father->left_son->data.i_num);

    if (father->right_son->type == INT)
        fprintf(asm_file, "POP ex\nPUSH %d\nPUSH ex\n", father->right_son->data.i_num);*/

    //fprintf(stdout, "dbg");

    if (father->left_son->type == INT)
        fprintf(asm_file, "PUSH %d\n", father->left_son->data.i_num);

    else if (father->left_son->type == VARIABLE)
    {
        HashList* found_variable = H_search_list_by_hash(tree, father->left_son->cell);

        fprintf(asm_file, "PUSH [%zu]\n", found_variable->ram_place);
    }

    if (father->right_son->type == INT)
        fprintf(asm_file, "PUSH %d\n", father->right_son->data.i_num);

    else if (father->right_son->type == VARIABLE)
    {
        HashList* found_variable = H_search_list_by_hash(tree, father->right_son->cell);

        fprintf(asm_file, "PUSH [%zu]\n", found_variable->ram_place);
    }

    fprintf(asm_file, "%s\n", command);
}
